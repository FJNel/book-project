<!DOCTYPE html>
<html data-bs-theme="light" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
  <title>The Book Project</title>
  <link rel="icon" type="image/png" sizes="500x499" href="assets/img/Icon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <style>
    .clickable-row { cursor: pointer; }
    .clickable-row:hover { background-color: #f8f9fa; }
    .clickable-row:active { background-color: #f1f3f5; }

    .tree-node {
      position: relative;
      padding-left: calc(var(--level, 0) * 1.1rem + 0.5rem);
    }

    .tree-node .node-row {
      border-radius: 0.5rem;
      padding: 0.4rem 0.5rem;
      transition: background-color 0.15s ease, border-color 0.15s ease;
    }

    .tree-node .node-row.selected {
      background: #f1f3f5;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    .tree-node .node-row:hover {
      background: #f8f9fa;
    }

    .tree-node:not(.tree-node-root)::before {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: calc(var(--level, 0) * 1.1rem + 0.15rem);
      width: 1px;
      background: rgba(0, 0, 0, 0.06);
    }

    .tree-caret {
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }

    .tree-caret:hover {
      background: rgba(0, 0, 0, 0.04);
    }

    .tree-count {
      font-size: 0.75rem;
      padding: 0.2rem 0.45rem;
    }

    .cover-thumb {
      width: 60px;
      height: 80px;
      object-fit: cover;
      background: #f1f3f5;
      border-radius: 0.35rem;
    }

    @media (max-width: 767.98px) {
      .list-table th.list-col-authors,
      .list-table th.list-col-type,
      .list-table th.list-col-language,
      .list-table th.list-col-published,
      .list-table th.list-col-tags,
      .list-table td.list-col-authors,
      .list-table td.list-col-type,
      .list-table td.list-col-language,
      .list-table td.list-col-published,
      .list-table td.list-col-tags {
        display: none;
      }
      .list-meta-mobile { display: block; }
    }

    .list-table th { white-space: nowrap; }
    .list-table td { vertical-align: middle; }
    .list-meta-mobile { display: none; }

    .details-pane {
      min-height: calc(100vh - 180px);
      display: flex;
      flex-direction: column;
    }

    .details-pane-card {
      flex: 1;
    }

    .details-header {
      border-bottom: 1px solid rgba(0,0,0,0.06);
      padding-bottom: 0.75rem;
      margin-bottom: 1rem;
    }

    .details-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem;
    }

    .details-card-fixed {
      min-height: 120px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="dashboard">The Book Project</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="dashboard">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="books">Books</a></li>
          <li class="nav-item"><a class="nav-link" href="publishers">Publishers</a></li>
          <li class="nav-item"><a class="nav-link" href="authors">Authors</a></li>
          <li class="nav-item"><a class="nav-link" href="series">Series</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="storage-locations">Storage Locations</a></li>
          <li class="nav-item"><a class="nav-link" href="statistics">Statistics</a></li>
        </ul>

        <div class="d-flex gap-2">
          <a class="btn btn-outline-secondary btn-sm" href="/account">Account</a>
          <button class="btn btn-outline-danger btn-sm js-logout-btn" type="button">Log out</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" id="pageLoadingModal">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header d-flex justify-content-center">
          <h4 class="modal-title text-center">Page Loading</h4>
        </div>
        <div class="modal-body d-flex justify-content-center align-items-center">
          <div>
            <p class="text-center">Please wait while the page is loading...</p>
            <div class="d-flex justify-content-center"><span class="spinner-border" role="status"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="apiErrorModal">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" data-lang="api_error_heading">API Connection Error</h4>
        </div>
        <div class="modal-body">
          <h5 data-lang="api_error_heading_2_1">Unable to Connect</h5>
          <p data-lang="api_error_1">We're having trouble connecting to our services right now. The application cannot load the data it needs to function correctly.</p>
          <h5 data-lang="api_error_heading_2_2">What you can do</h5>
          <ul>
            <li data-lang="api_error_li1"><strong>Check your internet connection:</strong> Make sure you are connected to the internet.</li>
            <li data-lang="api_error_li2"><strong>Please try again in a few minutes: </strong>This may be a temporary issue.</li>
          </ul>
          <p class="mb-0" data-lang="api_error_footer"><em>If the problem continues, please contact the System Administrator at </em><a href="mailto:support@fjnel.co.za?subject=The%20Book%20Project%3A%20API%20Connection%20Error">support@fjnel.co.za</a></p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="rateLimitModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Please Slow Down for a Moment</h4>
        </div>
        <div class="modal-body">
          <p class="mb-2">It looks like The Book Project has been opened or refreshed several times in a short period. Because of this, some essential information isn’t available right now.</p>
          <p class="mb-3">Nothing is wrong, and there’s nothing you need to do. This page will automatically reload at <strong id="rateLimitResetTime">soon</strong> once everything is ready again.</p>
          <p class="mb-2 text-muted">Preparing to continue…</p>
          <div class="progress" role="progressbar" aria-label="Rate limit reset progress" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" id="rateLimitProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="container-fluid py-3">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
      <div>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item"><a href="dashboard" class="text-decoration-none">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Storage Locations</li>
          </ol>
        </nav>
        <h1 class="mb-1">Storage Locations</h1>
        <p class="text-muted mb-0">Manage where your physical books live.</p>
      </div>
      <div class="d-flex flex-wrap gap-2 align-items-center"></div>
    </div>

    <div id="feedbackContainer" class="mb-3"></div>

    <div class="row g-3">
      <div class="col-12 col-md-4 col-lg-3">
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column gap-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-semibold">Locations</div>
              <div class="btn-group" role="group" aria-label="Tree actions">
                <button class="btn btn-outline-secondary btn-sm" type="button" id="expandAllBtn" title="Expand all"><i class="bi bi-arrows-expand"></i></button>
                <button class="btn btn-outline-secondary btn-sm" type="button" id="collapseAllBtn" title="Collapse all"><i class="bi bi-arrows-collapse"></i></button>
              </div>
            </div>

            <div>
              <label class="form-label text-muted small mb-1" for="treeSearchInput">Search locations</label>
              <div class="input-group">
                <span class="input-group-text" aria-hidden="true"><i class="bi bi-search"></i></span>
                <input class="form-control" id="treeSearchInput" type="text" placeholder="Type a name or path" autocomplete="off" />
                <button class="btn btn-outline-secondary" type="button" id="clearTreeSearchBtn"><i class="bi bi-x"></i><span class="d-none d-md-inline ms-1">Clear</span></button>
              </div>
            </div>

            <div class="d-grid">
              <button class="btn btn-primary" type="button" id="addRootBtn"><i class="bi bi-plus-circle"></i><span class="ms-2">Base location</span></button>
            </div>

            <div id="treeContainer" class="d-flex flex-column gap-1" style="max-height: calc(100vh - 260px); overflow-y: auto;"></div>
            <div id="treeEmptyState" class="text-muted text-center py-3 d-none">No storage locations yet.</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-8 col-lg-9">
        <div class="offcanvas-md offcanvas-end" tabindex="-1" id="detailsOffcanvas" aria-labelledby="detailsOffcanvasLabel">
          <div class="offcanvas-header border-bottom d-md-none">
            <div class="d-flex align-items-center gap-2">
              <button type="button" class="btn btn-link btn-sm text-decoration-none" data-bs-dismiss="offcanvas">Back to locations</button>
              <h5 class="offcanvas-title mb-0" id="detailsOffcanvasLabel">Location Details</h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body p-0">
            <div class="details-pane">
              <div class="card shadow-sm h-100 border-0 rounded-3 details-pane-card">
                <div class="card-body d-flex flex-column">
                  <div class="details-header d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
                    <div>
                      <div class="text-muted small">Selected location</div>
                      <h2 class="h4 mb-1" id="locationNameHeading">Select a location</h2>
                      <div class="text-muted small d-none" id="locationNotesHeading"></div>
                    </div>
                    <div class="d-flex flex-wrap gap-2" id="headerActions">
                      <button class="btn btn-primary btn-sm" type="button" id="addChildBtn" disabled><i class="bi bi-plus-circle"></i><span class="ms-1">Nested under an existing location</span></button>
                      <button class="btn btn-outline-secondary btn-sm" type="button" id="editBtn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                          <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"></path>
                        </svg>
                        <span class="ms-1">Edit</span>
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" type="button" id="moveBtn" disabled><i class="bi bi-arrows-move"></i><span class="ms-1">Move</span></button>
                      <button class="btn btn-outline-danger btn-sm" type="button" id="deleteBtn" disabled><i class="bi bi-trash"></i><span class="ms-1">Delete</span></button>
                    </div>
                  </div>

                  <div id="detailsEmptyState" class="text-muted text-center py-5 flex-grow-1 d-flex align-items-center justify-content-center">
                    Select a location to view details.
                  </div>
                  <div id="detailsLoadingState" class="text-muted text-center py-5 d-none flex-grow-1 d-flex align-items-center justify-content-center">
                    <div>
                      <div class="spinner-border text-secondary mb-3" role="status"></div>
                      <div>Loading location…</div>
                    </div>
                  </div>

                  <div id="detailsContent" class="d-none d-flex flex-column gap-3 flex-grow-1">
                    <div class="details-meta">
                      <div class="card shadow-sm details-card-fixed">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="fw-semibold">Location path</div>
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="copyPathBtn"><i class="bi bi-clipboard"></i> <span class="d-none d-sm-inline">Copy</span></button>
                          </div>
                          <nav aria-label="Location breadcrumb">
                            <ol class="breadcrumb mb-0" id="locationBreadcrumb"></ol>
                          </nav>
                        </div>
                      </div>

                      <div class="card shadow-sm details-card-fixed">
                        <div class="card-body">
                          <div class="text-muted small">Books in this location</div>
                          <div class="h4 mb-0" id="booksDirectStat">0</div>
                        </div>
                      </div>

                      <div class="card shadow-sm details-card-fixed">
                        <div class="card-body">
                          <div class="text-muted small">Books in subtree</div>
                          <div class="h4 mb-0" id="booksTotalStat">0</div>
                        </div>
                      </div>

                      <div class="card shadow-sm details-card-fixed">
                        <div class="card-body">
                          <div class="text-muted small">Child locations</div>
                          <div class="h4 mb-0" id="childrenCountStat">0</div>
                        </div>
                      </div>
                    </div>

                    <div class="card shadow-sm">
                      <div class="card-body">
                        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-2">
                          <div>
                            <div class="fw-semibold">Books in this location</div>
                            <div class="text-muted small" id="booksSummaryLine"></div>
                          </div>
                          <div class="d-flex flex-wrap gap-2 align-items-center">
                            <div class="btn-group" role="group" aria-label="Include subtree toggle">
                              <button class="btn btn-outline-secondary btn-sm" type="button" id="directOnlyBtn">Direct only</button>
                              <button class="btn btn-outline-secondary btn-sm" type="button" id="includeSubtreeBtn">Include sub-locations</button>
                            </div>
                            <select class="form-select form-select-sm" id="booksSortSelect" aria-label="Sort books" style="min-width: 200px;">
                              <option value="title:asc">Title (A to Z)</option>
                              <option value="title:desc">Title (Z to A)</option>
                              <option value="publicationDate:desc">Published date (newest first)</option>
                              <option value="publicationDate:asc">Published date (oldest first)</option>
                              <option value="createdAt:desc">Created at (newest first)</option>
                              <option value="updatedAt:desc">Updated at (newest first)</option>
                            </select>
                          </div>
                        </div>

                        <div class="table-responsive">
                          <table class="table list-table align-middle mb-0">
                            <thead>
                              <tr class="text-muted">
                                <th class="list-col-book">Book</th>
                                <th class="list-col-authors">Authors</th>
                                <th class="list-col-type">Type</th>
                                <th class="list-col-language">Language</th>
                                <th class="list-col-published">Published</th>
                                <th class="list-col-tags">Tags</th>
                              </tr>
                            </thead>
                            <tbody id="booksTableBody"></tbody>
                          </table>
                        </div>

                        <div id="booksEmptyState" class="text-center text-muted py-4 d-none">
                          No books found for this location.
                        </div>

                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
                          <div class="text-muted small" id="booksPaginationInfo">Page 1</div>
                          <nav aria-label="Location books pagination">
                            <ul class="pagination mb-0" id="booksPaginationNav"></ul>
                          </nav>
                          <div class="d-flex align-items-center gap-2">
                            <div>
                              <label class="form-label mb-0 text-muted small" for="booksPerPageInput">Per page</label>
                              <input type="number" class="form-control form-control-sm" id="booksPerPageInput" value="10" step="5" min="2" max="50" style="width: 90px;" />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="text-muted small" id="locationTimestampLine"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="sessionExpiredModal">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Session Expired!</h4>
          <button class="btn-close" aria-label="Close" data-bs-dismiss="modal" type="button"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Your session has ended for security reasons. This might happen due to:</p>
          <ul>
            <li><strong>Inactivity:</strong> You've been away for a while, and we need to confirm your identity.</li>
            <li><strong>Password Reset:</strong> You changed your password recently, so you need to log in again on all devices.</li>
            <li><strong>Manual Logout:</strong> You manually logged out on all devices.</li>
          </ul>
          <p class="mb-0"><em>Close this window to go back to the page where you can log in.</em></p>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Add location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 text-muted small d-none" id="addParentLine"></div>
          <div class="mb-3">
            <label class="form-label" for="addNameInput">Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="addNameInput" required maxlength="120" />
            <div class="form-text" id="addNameHelp">Enter a location name.</div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="addNotesInput">Notes</label>
            <textarea class="form-control" id="addNotesInput" rows="3" maxlength="500"></textarea>
            <div class="form-text" id="addNotesHelp">Optional notes about this location.</div>
          </div>
          <div id="addLocationError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit" id="addLocationSaveBtn" disabled>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="ms-1">Add location</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="editLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Edit location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" for="editNameInput">Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editNameInput" required maxlength="120" />
            <div class="form-text" id="editNameHelp">Enter a location name.</div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="editNotesInput">Notes</label>
            <textarea class="form-control" id="editNotesInput" rows="3" maxlength="500"></textarea>
            <div class="form-text" id="editNotesHelp">Optional notes about this location.</div>
          </div>
          <div class="mb-2" id="editChangesSummary" aria-live="polite">No changes yet.</div>
          <div id="editLocationError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit" id="editLocationSaveBtn" disabled>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="ms-1">Save changes</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="moveLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Move location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 text-muted" id="moveSummaryText"></div>
          <div class="mb-3">
            <label class="form-label" for="moveLocationSelect">New parent</label>
            <select class="form-select" id="moveLocationSelect" required></select>
            <div class="form-text" id="moveLocationHelp">Choose a parent that is not inside this location.</div>
          </div>
          <div id="moveLocationError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit" id="moveLocationConfirmBtn" disabled>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="ms-1">Move</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="deleteLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Delete location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2" id="deleteLocationMessage"></div>
          <div class="mb-3" id="deleteImpactNote" class="text-muted small"></div>
          <div class="mb-3">
            <label class="form-label" for="deleteConfirmInput">Type <strong>DELETE</strong> to confirm</label>
            <input type="text" class="form-control" id="deleteConfirmInput" autocomplete="off" />
          </div>
          <div id="deleteLocationError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer justify-content-between">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" type="submit" id="deleteLocationConfirmBtn" disabled>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="ms-1">Delete</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="sharedAddEntityModals"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/http-interceptor.js"></script>
  <script src="assets/js/common.js"></script>
  <script src="assets/js/shared-add-modals.js"></script>
  <script src="assets/js/storage-locations.js"></script>
</body>
</html>
