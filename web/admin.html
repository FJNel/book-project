<!DOCTYPE html>
<html data-bs-theme="light" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
  <script>
    (function () {
      try {
        const pref = localStorage.getItem('themePreference');
        const resolved = (pref === 'light' || pref === 'dark')
          ? pref
          : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-bs-theme', resolved);
      } catch (e) {
        document.documentElement.setAttribute('data-bs-theme', 'light');
      }
    })();
  </script>
  <title>The Book Project · Admin</title>
  <link rel="icon" type="image/png" sizes="500x499" href="assets/img/Icon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/vendor/bootstrap-icons/bootstrap-icons.css" />
  <style>
    .stats-nav .nav-link {
      border: 1px solid var(--bs-border-color);
      border-radius: 999px;
      font-weight: 600;
      color: var(--bs-body-color);
      background: var(--bs-body-bg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      transition: color 0.15s ease, background-color 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .stats-nav .nav-link:hover {
      color: var(--bs-primary);
      border-color: var(--bs-primary);
      background: var(--bs-tertiary-bg);
    }
    .stats-nav .nav-link:focus-visible { outline: none; box-shadow: var(--bs-focus-ring-box-shadow); }
    .stats-nav .nav-link.active {
      background: var(--bs-primary);
      border-color: var(--bs-primary);
      color: var(--bs-white);
      font-weight: 700;
      box-shadow: 0 10px 22px rgba(13, 110, 253, 0.2);
    }

    .stats-nav {
      flex-wrap: nowrap !important;
      overflow-x: auto;
      padding-bottom: 0.25rem;
    }

    .stats-nav .nav-link { white-space: nowrap; }

    .admin-card {
      border: 1px solid var(--bs-border-color);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
      background: var(--bs-body-bg);
    }
    .stat-pill {
      min-width: 92px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .table-fixed-sm td { white-space: nowrap; }
    .muted-label { font-size: 0.9rem; color: var(--bs-secondary-color); }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--bs-border-color);
      background-color: var(--bs-tertiary-bg);
      font-weight: 600;
      font-size: 0.9rem;
    }
    .chip-muted { color: var(--bs-secondary-color); }
    .chip-alert {
      color: var(--bs-danger-text-emphasis);
      border-color: var(--bs-danger-border-subtle);
    }
    .action-summary {
      border: 1px solid var(--bs-border-color);
      background: var(--bs-tertiary-bg);
      border-radius: 12px;
      padding: 12px;
    }
    .action-summary .label { color: var(--bs-secondary-color); font-size: 0.85rem; }
    .action-summary .summary-value { font-weight: 600; }
    .action-summary-list {
      display: grid;
      gap: 6px;
    }
    .action-summary-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }
    .action-summary-row span:last-child { text-align: right; }
    .insight-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid var(--bs-border-color);
    }
    .insight-item:last-child { border-bottom: none; }
    .insight-label { color: var(--bs-secondary-color); font-size: 0.9rem; }
    .insight-value { font-weight: 700; font-size: 1.05rem; }
    .insight-meta { color: var(--bs-secondary-color); font-size: 0.8rem; }
    .table-header th {
      background-color: var(--bs-tertiary-bg);
      color: var(--bs-body-color);
      border-bottom: 1px solid var(--bs-border-color);
    }
    .admin-table th,
    .admin-table td {
      vertical-align: middle;
    }
    .admin-table th.admin-col-actions,
    .admin-table td.admin-col-actions {
      width: 1%;
      white-space: nowrap;
    }
    .admin-table tbody tr.clickable-row {
      cursor: pointer;
    }
    .admin-table tbody tr.clickable-row:hover,
    .admin-table tbody tr.clickable-row:focus-within {
      background-color: var(--bs-tertiary-bg);
    }
    .row-actions {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.15s ease, visibility 0.15s ease;
    }
    .admin-table tbody tr:hover .row-actions,
    .admin-table tbody tr:focus-within .row-actions {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      padding: 0;
    }

    @media (max-width: 767.98px) {
      .row-actions {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
      .row-actions-desktop { display: none !important; }
    }
  </style>
</head>

<body>
  <div id="navbarContainer"></div>

  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" id="pageLoadingModal">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header d-flex justify-content-center">
          <h4 class="modal-title text-center">Page Loading</h4>
        </div>
        <div class="modal-body d-flex justify-content-center align-items-center">
          <div>
            <p class="text-center">Please wait while the page is loading...</p>
            <div class="d-flex justify-content-center"><span class="spinner-border" role="status"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="apiErrorModal">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" data-lang="api_error_heading">API Connection Error</h4>
        </div>
        <div class="modal-body">
          <h5 data-lang="api_error_heading_2_1">Unable to Connect</h5>
          <p data-lang="api_error_1">We're having trouble connecting to our services right now. The application cannot load the data it needs to function correctly.</p>
          <h5 data-lang="api_error_heading_2_2">What you can do</h5>
          <ul>
            <li data-lang="api_error_li1"><strong>Check your internet connection:</strong> Make sure you are connected to the internet.</li>
            <li data-lang="api_error_li2"><strong>Please try again in a few minutes: </strong>This may be a temporary issue.</li>
          </ul>
          <p class="mb-0" data-lang="api_error_footer"><em>If the problem continues, please contact the System Administrator at </em><a href="mailto:support@fjnel.co.za?subject=The%20Book%20Project%3A%20API%20Connection%20Error">support@fjnel.co.za</a></p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="rateLimitModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Please Slow Down for a Moment</h4>
        </div>
        <div class="modal-body">
          <p class="mb-2">It looks like The Book Project has been opened or refreshed several times in a short period. Because of this, some essential information isn’t available right now.</p>
          <p class="mb-3">Nothing is wrong, and there’s nothing you need to do. This page will automatically reload at <strong id="rateLimitResetTime">soon</strong> once everything is ready again.</p>
          <p class="mb-2 text-muted">Preparing to continue…</p>
          <div class="progress" role="progressbar" aria-label="Rate limit reset progress" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" id="rateLimitProgress" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="container py-4">
    <div class="mb-4">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2 small">
          <li class="breadcrumb-item"><a href="dashboard">Dashboard</a></li>
          <li class="breadcrumb-item active" aria-current="page">Admin</li>
        </ol>
      </nav>
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <h1 class="mb-1">Admin</h1>
          <p class="text-muted mb-0">Manage users, languages, and system status.</p>
        </div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <button class="btn btn-primary btn-sm" type="button" id="openCreateUserBtn"><i class="bi bi-plus-square me-1" aria-hidden="true"></i>Create user</button>
          <span class="chip chip-alert" id="adminRolePill">Role: unknown</span>
          <span class="chip chip-muted" id="adminStatusPill">Status: checking…</span>
        </div>
      </div>
    </div>

    <ul class="nav nav-pills flex-row gap-2 mb-4 stats-nav" id="adminSectionNav">
      <li class="nav-item"><button class="nav-link active" type="button" data-section="overview">Overview</button></li>
      <li class="nav-item"><button class="nav-link" type="button" data-section="statistics">Statistics</button></li>
      <li class="nav-item"><button class="nav-link" type="button" data-section="users">Users</button></li>
      <li class="nav-item"><button class="nav-link" type="button" data-section="libraries">Libraries</button></li>
      <li class="nav-item"><button class="nav-link" type="button" data-section="emails">Emails</button></li>
      <li class="nav-item"><button class="nav-link" type="button" data-section="usage-logs">Usage / Logs</button></li>
      <li class="nav-item"><button class="nav-link" type="button" data-section="data-tools">Data tools</button></li>
    </ul>

    <div class="alert alert-danger d-none" role="alert" id="adminAccessAlert">
      You need an administrator account to view this page. Redirecting to Dashboard…
    </div>

    <section class="mb-4 admin-section" id="overviewSection" data-section-content="overview">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card admin-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <p class="mb-1 text-uppercase text-muted small fw-semibold">System Status</p>
                  <h2 class="h5 mb-0">API &amp; Services</h2>
                </div>
                <span class="badge text-bg-secondary" id="statusBadge">Checking…</span>
              </div>
              <div class="d-flex flex-column gap-2">
                <div class="d-flex justify-content-between">
                  <span class="muted-label">API</span>
                  <span id="apiStatusText" class="fw-semibold">—</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="muted-label">Database latency</span>
                  <span class="fw-semibold" id="dbLatencyText">—</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="muted-label">Schema readiness</span>
                  <span class="fw-semibold" id="schemaStatusText">—</span>
                </div>
                <div class="text-muted small d-none" id="schemaDetails"></div>
                <div class="d-flex justify-content-between">
                  <span class="muted-label">DB SSL mode</span>
                  <span class="fw-semibold" id="dbSslModeText">—</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="muted-label">Email queue</span>
                  <span class="fw-semibold" id="queueText">—</span>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted small" id="statusUpdatedAt">Last checked just now</div>
                <div class="btn-group">
                  <button class="btn btn-outline-secondary btn-sm" type="button" id="refreshStatusBtn">Refresh</button>
                </div>
              </div>
              <div class="alert alert-warning d-none mt-3" id="statusAlert"></div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card admin-card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <p class="mb-1 text-uppercase text-muted small fw-semibold">Quick Tools</p>
                  <h2 class="h5 mb-0">Admin Shortcuts</h2>
                </div>
                <span class="badge text-bg-primary">Admin</span>
              </div>
              <div class="d-flex flex-column gap-3">
                <div>
                  <p class="mb-1 fw-semibold">User Management</p>
                  <p class="text-muted mb-2 small">Search users, review status, and manage access.</p>
                  <a class="btn btn-outline-primary btn-sm" href="#usersSection">Go to Users</a>
                </div>
                <div>
                  <p class="mb-1 fw-semibold">Languages</p>
                  <p class="text-muted mb-2 small">Maintain the shared language list for the library.</p>
                  <a class="btn btn-outline-primary btn-sm" href="#librariesSection">Manage Libraries</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-4 admin-section d-none" id="statisticsSection" data-section-content="statistics">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
        <div>
          <h2 class="h4 mb-1">Admin insights</h2>
          <p class="text-muted mb-0">Snapshot across the platform with correlation-only signals.</p>
        </div>
        <button class="btn btn-outline-secondary btn-sm" type="button" id="refreshSiteStatsBtn">Refresh</button>
      </div>
      <div id="siteStatsAlert" class="alert alert-danger d-none" role="alert"></div>
      <div class="row g-3 mb-3">
        <div class="col-12 col-lg-4">
          <div class="card admin-card h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted">Users</h6>
              <div class="d-flex flex-column gap-2">
                <div><span class="muted-label">Total</span><div class="fw-semibold" id="siteUsersTotal">—</div></div>
                <div><span class="muted-label">Verified</span><div class="fw-semibold" id="siteUsersVerified">—</div></div>
                <div><span class="muted-label">Disabled</span><div class="fw-semibold" id="siteUsersDisabled">—</div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card admin-card h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted">Books</h6>
              <div class="d-flex flex-column gap-2">
                <div><span class="muted-label">Total</span><div class="fw-semibold" id="siteBooksTotal">—</div></div>
                <div><span class="muted-label">Active</span><div class="fw-semibold" id="siteBooksActive">—</div></div>
                <div><span class="muted-label">Removed</span><div class="fw-semibold" id="siteBooksDeleted">—</div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card admin-card h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted">Library</h6>
              <div class="d-flex flex-column gap-2">
                <div><span class="muted-label">Authors</span><div class="fw-semibold" id="siteAuthorsTotal">—</div></div>
                <div><span class="muted-label">Publishers</span><div class="fw-semibold" id="sitePublishersTotal">—</div></div>
                <div><span class="muted-label">Series</span><div class="fw-semibold" id="siteSeriesTotal">—</div></div>
                <div><span class="muted-label">Book types</span><div class="fw-semibold" id="siteBookTypesTotal">—</div></div>
                <div><span class="muted-label">Tags</span><div class="fw-semibold" id="siteTagsTotal">—</div></div>
                <div><span class="muted-label">Storage locations</span><div class="fw-semibold" id="siteStorageTotal">—</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row g-3">
        <div class="col-12 col-lg-4">
          <div class="card admin-card h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted">Adoption</h6>
              <div class="d-flex flex-column gap-2" id="siteInsightsAdoption">
                <div class="text-muted small">Loading insights…</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card admin-card h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted">Content quality</h6>
              <div class="d-flex flex-column gap-2" id="siteInsightsQuality">
                <div class="text-muted small">Loading insights…</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card admin-card h-100">
            <div class="card-body">
              <h6 class="text-uppercase text-muted">Engagement</h6>
              <div class="d-flex flex-column gap-2" id="siteInsightsEngagement">
                <div class="text-muted small">Loading insights…</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-5 admin-section d-none" id="usersSection" data-section-content="users">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
          <p class="mb-1 text-uppercase text-muted small fw-semibold">Users</p>
          <h2 class="h5 mb-0">User Directory</h2>
        </div>
        <div class="d-flex flex-wrap gap-2 align-items-center"></div>
      </div>

      <div class="card admin-card mb-3">
        <div class="card-body">
          <div class="row g-2 align-items-end">
            <div class="col-12 col-lg-6">
              <label class="form-label fw-semibold mb-1" for="userSearchInput">Search by email</label>
              <div class="input-group">
                <span class="input-group-text" aria-hidden="true">
                  <i class="bi bi-search"></i>
                </span>
                <input class="form-control" type="search" placeholder="Search email…" aria-label="Search email" id="userSearchInput" />
                <button class="btn btn-outline-secondary" type="button" id="clearUsersSearchBtn">Clear</button>
              </div>
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold mb-1" for="usersSortSelect">Sort</label>
              <select class="form-select" id="usersSortSelect" aria-label="Sort users">
                <option value="email:asc">Email (A to Z)</option>
                <option value="createdAt:desc">Created (newest first)</option>
                <option value="createdAt:asc">Created (oldest first)</option>
                <option value="lastLogin:desc">Last login (newest first)</option>
              </select>
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold mb-1 d-none d-lg-block">&nbsp;</label>
              <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#usersFiltersOffcanvas" aria-controls="usersFiltersOffcanvas" aria-label="Advanced filters">Advanced filters</button>
            </div>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-2 mt-3" id="usersActiveFiltersBar">
            <span class="text-muted small">Active filters:</span>
            <div id="usersActiveFilters" class="d-flex flex-wrap gap-2"></div>
            <button class="btn btn-link btn-sm p-0 d-none" type="button" id="clearUsersFiltersBtn">Clear all filters</button>
          </div>
        </div>
      </div>
      <div class="alert alert-success d-none" id="usersSuccess"></div>
      <div class="alert alert-warning d-none" id="usersAlert"></div>
      <div class="table-responsive">
        <table class="table table-sm align-middle table-striped table-fixed-sm admin-table">
          <thead class="table-header">
            <tr>
              <th scope="col">User</th>
              <th scope="col">Usage</th>
              <th scope="col">Library</th>
              <th scope="col">Access</th>
              <th scope="col">Status</th>
              <th scope="col" class="admin-col-actions text-end">Actions</th>
            </tr>
          </thead>
          <tbody id="usersTbody">
            <tr><td colspan="6" class="text-center text-muted py-3">Loading users…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mt-2 gap-2">
        <div class="d-flex align-items-center gap-2">
          <div class="text-muted small" id="usersSummary">Showing users</div>
          <div class="text-muted small" id="usersPageInfo">Page 1</div>
          <nav aria-label="Users pagination">
            <ul class="pagination mb-0" id="usersPagination"></ul>
          </nav>
        </div>
        <div>
          <label class="form-label mb-0 text-muted small" for="usersPerPage">Per page</label>
          <input class="form-control form-control-sm" type="number" min="5" max="100" step="5" value="25" id="usersPerPage" aria-label="Users per page" style="width: 90px" />
        </div>
      </div>
    </section>

    <section class="mb-4 admin-section d-none" id="librariesSection" data-section-content="libraries">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
          <p class="mb-1 text-uppercase text-muted small fw-semibold">Libraries</p>
          <h2 class="h5 mb-0">Library Maintenance</h2>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-primary btn-sm" type="button" id="openCreateLanguageBtnSecondary">Create language</button>
        </div>
      </div>
      <div class="row g-3 mb-3">
        <div class="col-12 col-lg-6">
          <div class="card admin-card h-100">
            <div class="card-body">
              <div class="fw-semibold mb-1">User libraries</div>
              <div class="text-muted small mb-3">Open a read-only view of a user's library and book list.</div>
              <a class="btn btn-outline-primary btn-sm" href="admin-library">Open library viewer</a>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card admin-card h-100">
            <div class="card-body">
              <div class="fw-semibold mb-1">Language list</div>
              <div class="text-muted small mb-3">Maintain the shared languages list used across libraries.</div>
              <a class="btn btn-outline-primary btn-sm" href="#languagesTable">Jump to languages</a>
            </div>
          </div>
        </div>
      </div>
      <div class="alert alert-success d-none" id="languagesSuccess"></div>
      <div class="alert alert-warning d-none" id="languagesAlert"></div>
      <div class="card admin-card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle table-striped admin-table" id="languagesTable">
              <thead class="table-header">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Name</th>
                  <th scope="col">Normalized</th>
                  <th scope="col">Created</th>
                  <th scope="col">Updated</th>
                  <th scope="col" class="admin-col-actions text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="languagesTbody">
                <tr><td colspan="6" class="text-center text-muted py-3">Loading languages…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-4 admin-section d-none" id="emailsSection" data-section-content="emails">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
          <p class="mb-1 text-uppercase text-muted small fw-semibold">Emails</p>
          <h2 class="h5 mb-0">Admin Email Tools</h2>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="emailTypesRefreshBtn">Refresh types</button>
        </div>
      </div>
      <div class="alert alert-success d-none" id="emailsSuccess"></div>
      <div class="alert alert-warning d-none" id="emailsAlert"></div>
      <div class="card admin-card">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label" for="emailTypeSelect">Email type</label>
              <select class="form-select" id="emailTypeSelect">
                <option value="">Select an email type</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="emailRecipientInput">Recipient email</label>
              <input class="form-control" type="email" id="emailRecipientInput" placeholder="admin@example.com" />
              <div class="form-text text-danger" id="emailRecipientHelp"></div>
            </div>
            <div class="col-12">
              <div class="small text-muted" id="emailTypeDescription">Select an email type to see the supported fields.</div>
            </div>
            <div class="col-12" id="emailTypeFields"></div>
            <div class="col-12 d-flex flex-wrap justify-content-between align-items-center gap-2">
              <div class="text-muted small">This is a test email. It does not change user data.</div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" type="button" id="emailResetBtn">Clear</button>
                <button class="btn btn-primary" type="button" id="emailSendTestBtn" disabled>Send test email</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card admin-card mt-3">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <div>
              <p class="mb-1 text-uppercase text-muted small fw-semibold">Development updates</p>
              <h3 class="h6 mb-0">Send features announcement</h3>
            </div>
            <span class="badge text-bg-secondary" id="devEmailStatus">Draft</span>
          </div>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label" for="devEmailSubject">Subject</label>
              <input class="form-control" type="text" id="devEmailSubject" maxlength="160" placeholder="What’s new in The Book Project" />
              <div class="form-text text-danger" id="devEmailSubjectHelp"></div>
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label" for="devEmailBody">Markdown body</label>
              <textarea class="form-control" id="devEmailBody" rows="8" placeholder="## Release notes\n- New features...\n" ></textarea>
              <div class="form-text text-danger" id="devEmailBodyHelp"></div>
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label" for="devEmailPreview">Preview</label>
              <div class="markdown-preview" id="devEmailPreview" aria-live="polite"></div>
              <div class="form-text text-muted">Preview uses GitHub Markdown rendering and may differ slightly from the final email.</div>
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label" for="devEmailTestRecipient">Send test to</label>
              <input class="form-control" type="email" id="devEmailTestRecipient" placeholder="admin@example.com" />
              <div class="form-text text-danger" id="devEmailTestHelp"></div>
            </div>
            <div class="col-12 col-lg-6 d-flex align-items-end gap-2">
              <button class="btn btn-outline-secondary" type="button" id="devEmailTestBtn">Send test</button>
              <button class="btn btn-primary" type="button" id="devEmailSendBtn">Send to opted-in users</button>
            </div>
            <div class="col-12">
              <div class="small text-muted" id="devEmailSummary">No sends yet.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card admin-card mt-3">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <div>
              <p class="mb-1 text-uppercase text-muted small fw-semibold">Email send history</p>
              <h3 class="h6 mb-0">Recent delivery attempts</h3>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <button class="btn btn-outline-secondary btn-sm" type="button" id="emailHistoryRefreshBtn">Refresh</button>
            </div>
          </div>
          <div class="alert alert-warning d-none" id="emailHistoryAlert"></div>
          <div class="row g-2 align-items-end mb-3">
            <div class="col-12 col-lg-6">
              <label class="form-label fw-semibold mb-1" for="emailHistoryRecipient">Search recipient</label>
              <div class="input-group">
                <span class="input-group-text" aria-hidden="true">
                  <i class="bi bi-search"></i>
                </span>
                <input class="form-control" type="search" id="emailHistoryRecipient" placeholder="Recipient contains" aria-label="Filter recipient" />
                <button class="btn btn-outline-secondary" type="button" id="emailHistoryClearSearchBtn">Clear</button>
              </div>
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold mb-1 d-none d-lg-block">&nbsp;</label>
              <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#emailHistoryFiltersOffcanvas" aria-controls="emailHistoryFiltersOffcanvas" aria-label="Advanced filters">Advanced filters</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle table-striped table-fixed-sm admin-table">
              <thead class="table-header">
                <tr>
                  <th scope="col">Type</th>
                  <th scope="col">Recipient</th>
                  <th scope="col">Queued</th>
                  <th scope="col">Sent</th>
                  <th scope="col">Status</th>
                  <th scope="col">Retries</th>
                  <th scope="col">Failure reason</th>
                </tr>
              </thead>
              <tbody id="emailHistoryTbody">
                <tr><td colspan="7" class="text-center text-muted py-3">Loading history…</td></tr>
              </tbody>
            </table>
          </div>
          <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mt-2 gap-2">
            <div class="d-flex align-items-center gap-2">
              <div class="text-muted small" id="emailHistorySummary">Showing email history</div>
              <div class="text-muted small" id="emailHistoryPageInfo">Page 1</div>
              <nav aria-label="Email history pagination">
                <ul class="pagination mb-0" id="emailHistoryPagination"></ul>
              </nav>
            </div>
            <div>
              <label class="form-label mb-0 text-muted small" for="emailHistoryPageSize">Per page</label>
              <input class="form-control form-control-sm" type="number" min="5" max="100" step="5" value="25" id="emailHistoryPageSize" aria-label="Page size" style="width: 90px" />
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-2 admin-section d-none" id="usageLogsNavSection" data-section-content="usage-logs">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
        <div>
          <p class="mb-1 text-uppercase text-muted small fw-semibold">Usage / Logs</p>
          <h2 class="h5 mb-0">Operational insight</h2>
        </div>
        <ul class="nav nav-pills gap-2" id="usageLogsNav" role="tablist">
          <li class="nav-item"><button class="nav-link active" type="button" data-usage-panel="logs">Logs</button></li>
          <li class="nav-item"><button class="nav-link" type="button" data-usage-panel="usage">Usage</button></li>
        </ul>
      </div>
    </section>

    <section class="mb-4 admin-section d-none usage-panel" id="logsSection" data-section-content="usage-logs" data-usage-panel="logs">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
          <p class="mb-1 text-uppercase text-muted small fw-semibold">Logs</p>
          <h2 class="h5 mb-0">Audit and HTTP logs</h2>
        </div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="logsRefreshBtn">Refresh</button>
        </div>
      </div>
      <div class="alert alert-warning d-none" id="logsAlert"></div>

      <div class="card admin-card mb-3">
        <div class="card-body">
          <div class="row g-2 align-items-end mb-3">
            <div class="col-12 col-lg-6">
              <label class="form-label fw-semibold mb-1" for="logsSearchInput">Search</label>
              <div class="input-group">
                <span class="input-group-text" aria-hidden="true">
                  <i class="bi bi-search"></i>
                </span>
                <input class="form-control" type="search" placeholder="Search text" aria-label="Search logs" id="logsSearchInput" />
                <button class="btn btn-outline-secondary" type="button" id="logsClearSearchBtn">Clear</button>
              </div>
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold mb-1 d-none d-lg-block">&nbsp;</label>
              <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#logsFiltersOffcanvas" aria-controls="logsFiltersOffcanvas" aria-label="Advanced filters">Advanced filters</button>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
            <div class="text-muted small" id="logsSummary">Showing logs</div>
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0 text-muted small" for="logsPageSize">Per page</label>
              <input class="form-control form-control-sm" type="number" id="logsPageSize" aria-label="Logs page size" value="25" min="5" max="200" step="5" style="width: 90px" />
              <div class="text-muted small" id="logsPageInfo">Page 1</div>
              <nav aria-label="Logs pagination">
                <ul class="pagination mb-0" id="logsPagination"></ul>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <div class="card admin-card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle table-striped admin-table">
              <thead class="table-header">
                <tr>
                  <th scope="col">Timestamp</th>
                  <th scope="col">Level</th>
                  <th scope="col">Type</th>
                  <th scope="col">Status</th>
                  <th scope="col">Actor</th>
                  <th scope="col">Details</th>
                  <th scope="col">Path</th>
                  <th scope="col">Duration</th>
                  <th scope="col" class="admin-col-actions text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="logsTbody">
                <tr><td colspan="9" class="text-center text-muted py-3">Load filters or refresh to view logs.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-4 admin-section d-none usage-panel" id="usageSection" data-section-content="usage-logs" data-usage-panel="usage">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
          <p class="mb-1 text-uppercase text-muted small fw-semibold">Usage</p>
          <h2 class="h5 mb-0">Usage ranking for users and API keys</h2>
        </div>
        <button class="btn btn-outline-secondary btn-sm" type="button" id="usageRefreshBtn">Refresh</button>
      </div>
      <div class="alert alert-warning d-none" id="usageAlert"></div>

      <div class="card admin-card mb-3">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input class="form-control form-control-sm" type="datetime-local" id="usageDateFrom" aria-label="Usage start date" />
            <input class="form-control form-control-sm" type="datetime-local" id="usageDateTo" aria-label="Usage end date" />
            <select class="form-select form-select-sm" id="usageSortBy" aria-label="Usage sort" style="min-width: 160px">
              <option value="usageScore">Sort: usage score</option>
              <option value="requests">Sort: requests</option>
              <option value="lastSeen">Sort: last seen</option>
            </select>
            <select class="form-select form-select-sm" id="usageSortOrder" aria-label="Usage sort order" style="width: 120px">
              <option value="desc">Desc</option>
              <option value="asc">Asc</option>
            </select>
            <input class="form-control form-control-sm" type="number" id="usageTopLimit" min="1" max="15" value="5" style="width: 120px" aria-label="Top endpoints" placeholder="Top N" />
          </div>
        </div>
      </div>

      <ul class="nav nav-tabs" id="usageTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="usageUsersTab" data-bs-toggle="tab" data-bs-target="#usageUsers" type="button" role="tab">User usage</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="usageApiKeysTab" data-bs-toggle="tab" data-bs-target="#usageApiKeys" type="button" role="tab">API key usage</button>
        </li>
      </ul>
      <div class="tab-content border border-top-0 rounded-bottom p-3">
        <div class="tab-pane fade show active" id="usageUsers" role="tabpanel">
          <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <input class="form-control form-control-sm" type="number" min="1" placeholder="User ID" id="usageUserId" aria-label="User id filter" style="width: 120px" />
            <input class="form-control form-control-sm" type="email" placeholder="User email" id="usageUserEmail" aria-label="User email filter" style="min-width: 220px" />
            <input class="form-control form-control-sm" type="text" placeholder="Path contains" id="usageUserPath" aria-label="Path filter" style="min-width: 200px" />
          </div>
          <div class="text-muted small mb-2" id="usageUsersSummary">No usage loaded yet.</div>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle admin-table">
              <thead class="table-header">
                <tr>
                  <th>Rank</th>
                  <th>User</th>
                  <th>Usage score</th>
                  <th>Requests</th>
                  <th>Top endpoints</th>
                  <th>Last seen</th>
                  <th class="admin-col-actions text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="usageUsersTbody">
                <tr><td colspan="7" class="text-center text-muted py-3">Refresh to load usage.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="usageApiKeys" role="tabpanel">
          <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <input class="form-control form-control-sm" type="number" min="1" placeholder="API key ID" id="usageApiKeyId" aria-label="API key id filter" style="width: 130px" />
            <input class="form-control form-control-sm" type="text" placeholder="API key label" id="usageApiKeyLabel" aria-label="API key label filter" style="min-width: 200px" />
            <input class="form-control form-control-sm" type="email" placeholder="User email" id="usageApiKeyEmail" aria-label="User email filter" style="min-width: 220px" />
          </div>
          <div class="text-muted small mb-2" id="usageApiKeysSummary">No usage loaded yet.</div>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle admin-table">
              <thead class="table-header">
                <tr>
                  <th>Rank</th>
                  <th>API key</th>
                  <th>User</th>
                  <th>Usage score</th>
                  <th>Requests</th>
                  <th>Top endpoints</th>
                  <th>Last seen</th>
                  <th class="admin-col-actions text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="usageApiKeysTbody">
                <tr><td colspan="8" class="text-center text-muted py-3">Refresh to load usage.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-4 admin-section d-none" id="dataToolsSection" data-section-content="data-tools">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
          <p class="mb-1 text-uppercase text-muted small fw-semibold">Data tools</p>
          <h2 class="h5 mb-0">Admin data viewer</h2>
        </div>
        <div class="text-muted small">Sanitized, read-only tables only.</div>
      </div>
      <div class="alert alert-warning d-none" id="dataViewerAlert" role="alert"></div>
      <div class="card admin-card">
        <div class="card-body">
          <div class="row g-2 align-items-end mb-3">
            <div class="col-12 col-lg-4">
              <label class="form-label fw-semibold mb-1" for="dataViewerTable">Table</label>
              <select class="form-select" id="dataViewerTable"></select>
              <div class="form-text text-muted" id="dataViewerTableHelp"></div>
            </div>
            <div class="col-12 col-lg-5">
              <label class="form-label fw-semibold mb-1" for="dataViewerSearch">Search</label>
              <div class="input-group">
                <span class="input-group-text" aria-hidden="true">
                  <i class="bi bi-search"></i>
                </span>
                <input class="form-control" type="text" id="dataViewerSearch" placeholder="Search text" />
                <button class="btn btn-outline-secondary" type="button" id="dataViewerClearSearchBtn">Clear</button>
              </div>
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label fw-semibold mb-1 d-none d-lg-block">&nbsp;</label>
              <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#dataViewerFiltersOffcanvas" aria-controls="dataViewerFiltersOffcanvas" aria-label="Advanced filters">Advanced filters</button>
            </div>
          </div>
          <div class="text-muted small mb-2" id="dataViewerSummary">Select a table to load data.</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle table-striped admin-table">
              <thead class="table-header" id="dataViewerThead"></thead>
              <tbody id="dataViewerTbody">
                <tr><td class="text-center text-muted py-3">No data loaded.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="sessionExpiredModal">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Session Expired!</h4>
          <button class="btn-close" aria-label="Close" data-bs-dismiss="modal" type="button"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Your session has ended for security reasons. This might happen due to:</p>
          <ul>
            <li><strong>Inactivity:</strong> You've been away for a while, and we need to confirm your access.</li>
            <li><strong>Password Reset:</strong> You changed your password recently, so you need to log in again on all devices.</li>
            <li><strong>Manual Logout:</strong> You manually logged out on all devices.</li>
          </ul>
          <p class="mb-0"><em>Close this window to go back to the page where you can log in.</em></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Users: Advanced Filters -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="usersFiltersOffcanvas" aria-labelledby="usersFiltersOffcanvasLabel" data-bs-backdrop="static" data-bs-scroll="true">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="usersFiltersOffcanvasLabel">Advanced filters</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="d-flex flex-column gap-3">
        <div>
          <label class="form-label small mb-1" for="userRoleFilter">Role</label>
          <select class="form-select" id="userRoleFilter" aria-label="Filter role">
            <option value="">Role: any</option>
            <option value="admin">Admin</option>
            <option value="user">User</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1" for="userVerifiedFilter">Verified</label>
          <select class="form-select" id="userVerifiedFilter" aria-label="Filter verified">
            <option value="">Verified: any</option>
            <option value="true">Verified</option>
            <option value="false">Not verified</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1" for="userDisabledFilter">Disabled</label>
          <select class="form-select" id="userDisabledFilter" aria-label="Filter disabled">
            <option value="">Disabled: any</option>
            <option value="false">Active</option>
            <option value="true">Disabled</option>
          </select>
        </div>
      </div>
    </div>
    <div class="offcanvas-footer border-top p-3 d-flex justify-content-between">
      <button class="btn btn-outline-secondary btn-sm" type="button" id="usersResetFiltersBtn">Reset filters</button>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" type="button" id="usersApplyFiltersBtn" data-bs-dismiss="offcanvas">Apply &amp; close</button>
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-dismiss="offcanvas">Close</button>
      </div>
    </div>
  </div>

  <!-- Email History: Advanced Filters -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="emailHistoryFiltersOffcanvas" aria-labelledby="emailHistoryFiltersOffcanvasLabel" data-bs-backdrop="static" data-bs-scroll="true">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="emailHistoryFiltersOffcanvasLabel">Advanced filters</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="d-flex flex-column gap-3">
        <div>
          <label class="form-label small mb-1" for="emailHistoryTypeFilter">Email type</label>
          <select class="form-select" id="emailHistoryTypeFilter" aria-label="Filter email type">
            <option value="">Type: any</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1" for="emailHistoryStatusFilter">Status</label>
          <select class="form-select" id="emailHistoryStatusFilter" aria-label="Filter status">
            <option value="">Status: any</option>
            <option value="queued">Queued</option>
            <option value="sent">Sent</option>
            <option value="failed">Failed</option>
            <option value="skipped">Skipped</option>
          </select>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small mb-1" for="emailHistoryDateFrom">Start date</label>
            <input class="form-control" type="date" id="emailHistoryDateFrom" aria-label="Start date" />
          </div>
          <div class="col-6">
            <label class="form-label small mb-1" for="emailHistoryDateTo">End date</label>
            <input class="form-control" type="date" id="emailHistoryDateTo" aria-label="End date" />
          </div>
        </div>
      </div>
    </div>
    <div class="offcanvas-footer border-top p-3 d-flex justify-content-between">
      <button class="btn btn-outline-secondary btn-sm" type="button" id="emailHistoryResetFiltersBtn">Reset filters</button>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" type="button" id="emailHistoryApplyFiltersBtn" data-bs-dismiss="offcanvas">Apply &amp; close</button>
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-dismiss="offcanvas">Close</button>
      </div>
    </div>
  </div>

  <!-- Logs: Advanced Filters -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="logsFiltersOffcanvas" aria-labelledby="logsFiltersOffcanvasLabel" data-bs-backdrop="static" data-bs-scroll="true">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="logsFiltersOffcanvasLabel">Advanced filters</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="d-flex flex-column gap-3">
        <div>
          <label class="form-label small mb-1" for="logsTypeFilter">Type</label>
          <select class="form-select" id="logsTypeFilter" aria-label="Filter log type">
            <option value="">Type: any</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1" for="logsLevelFilter">Level</label>
          <select class="form-select" id="logsLevelFilter" aria-label="Filter log level">
            <option value="">Level: any</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1" for="logsStatusFilter">Status</label>
          <select class="form-select" id="logsStatusFilter" aria-label="Filter log status">
            <option value="">Status: any</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1" for="logsMethodFilter">Method</label>
          <select class="form-select" id="logsMethodFilter" aria-label="Filter HTTP method">
            <option value="">Method: any</option>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="PATCH">PATCH</option>
            <option value="DELETE">DELETE</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1" for="logsActorFilter">Actor</label>
          <select class="form-select" id="logsActorFilter" aria-label="Filter actor type">
            <option value="">Actor: any</option>
            <option value="user">User</option>
            <option value="api_key">API key</option>
            <option value="anonymous">Anonymous</option>
          </select>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small mb-1" for="logsStatusMin">Status min</label>
            <input class="form-control" type="number" min="100" max="599" id="logsStatusMin" aria-label="Status code minimum" />
          </div>
          <div class="col-6">
            <label class="form-label small mb-1" for="logsStatusMax">Status max</label>
            <input class="form-control" type="number" min="100" max="599" id="logsStatusMax" aria-label="Status code maximum" />
          </div>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small mb-1" for="logsDateFrom">Start date</label>
            <input class="form-control" type="datetime-local" id="logsDateFrom" aria-label="Start date" />
          </div>
          <div class="col-6">
            <label class="form-label small mb-1" for="logsDateTo">End date</label>
            <input class="form-control" type="datetime-local" id="logsDateTo" aria-label="End date" />
          </div>
        </div>
        <div>
          <label class="form-label small mb-1" for="logsPathFilter">Path contains</label>
          <input class="form-control" type="text" id="logsPathFilter" aria-label="Path filter" />
        </div>
        <div>
          <label class="form-label small mb-1" for="logsUserIdFilter">User ID</label>
          <input class="form-control" type="number" min="1" id="logsUserIdFilter" aria-label="User id filter" />
        </div>
        <div>
          <label class="form-label small mb-1" for="logsUserEmailFilter">User email</label>
          <input class="form-control" type="email" id="logsUserEmailFilter" aria-label="User email filter" />
        </div>
        <div>
          <label class="form-label small mb-1" for="logsApiKeyIdFilter">API key ID</label>
          <input class="form-control" type="number" min="1" id="logsApiKeyIdFilter" aria-label="API key id filter" />
        </div>
        <div>
          <label class="form-label small mb-1" for="logsApiKeyLabelFilter">API key label</label>
          <input class="form-control" type="text" id="logsApiKeyLabelFilter" aria-label="API key label filter" />
        </div>
        <div>
          <label class="form-label small mb-1" for="logsApiKeyPrefixFilter">API key prefix</label>
          <input class="form-control" type="text" id="logsApiKeyPrefixFilter" aria-label="API key prefix filter" />
        </div>
      </div>
    </div>
    <div class="offcanvas-footer border-top p-3 d-flex justify-content-between">
      <button class="btn btn-outline-secondary btn-sm" type="button" id="logsResetFiltersBtn">Reset filters</button>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" type="button" id="logsApplyFiltersBtn" data-bs-dismiss="offcanvas">Apply &amp; close</button>
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-dismiss="offcanvas">Close</button>
      </div>
    </div>
  </div>

  <!-- Data Tools: Advanced Filters -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="dataViewerFiltersOffcanvas" aria-labelledby="dataViewerFiltersOffcanvasLabel" data-bs-backdrop="static" data-bs-scroll="true">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="dataViewerFiltersOffcanvasLabel">Advanced filters</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="d-flex flex-column gap-3">
        <div>
          <label class="form-label small mb-1" for="dataViewerUserId">User ID</label>
          <input class="form-control" type="number" id="dataViewerUserId" min="1" />
          <div class="form-text text-danger" id="dataViewerUserIdHelp"></div>
        </div>
        <div>
          <label class="form-label small mb-1" for="dataViewerEmail">Email</label>
          <input class="form-control" type="email" id="dataViewerEmail" placeholder="user@example.com" />
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small mb-1" for="dataViewerSort">Sort by</label>
            <select class="form-select" id="dataViewerSort"></select>
          </div>
          <div class="col-6">
            <label class="form-label small mb-1" for="dataViewerOrder">Order</label>
            <select class="form-select" id="dataViewerOrder">
              <option value="desc">Desc</option>
              <option value="asc">Asc</option>
            </select>
          </div>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small mb-1" for="dataViewerLimit">Page size</label>
            <input class="form-control" type="number" id="dataViewerLimit" min="5" max="200" step="5" value="25" />
            <div class="form-text text-danger" id="dataViewerLimitHelp"></div>
          </div>
          <div class="col-6">
            <label class="form-label small mb-1" for="dataViewerPage">Page</label>
            <input class="form-control" type="number" id="dataViewerPage" min="1" value="1" />
            <div class="form-text text-danger" id="dataViewerPageHelp"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="offcanvas-footer border-top p-3 d-flex justify-content-between">
      <button class="btn btn-outline-secondary btn-sm" type="button" id="dataViewerResetFiltersBtn">Reset filters</button>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" type="button" id="dataViewerApplyFiltersBtn" data-bs-dismiss="offcanvas">Apply &amp; close</button>
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-dismiss="offcanvas">Close</button>
      </div>
    </div>
  </div>

  <!-- Create User Modal -->
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="createUserModal" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createUserModalLabel">Create user</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="createUserAlert"></div>
          <form id="createUserForm" novalidate>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="createFullName">Full name</label>
                <input class="form-control" type="text" id="createFullName" required />
                <div class="form-text text-danger" id="createFullNameHelp"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="createPreferredName">Preferred name</label>
                <input class="form-control" type="text" id="createPreferredName" />
                <div class="form-text text-danger" id="createPreferredNameHelp"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="createEmail">Email</label>
                <input class="form-control" type="email" id="createEmail" required />
                <div class="form-text text-danger" id="createEmailHelp"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="createRole">Role</label>
                <select class="form-select" id="createRole" required>
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="createPassword">Password</label>
                <input class="form-control" type="password" id="createPassword" autocomplete="new-password" />
                <div class="form-text text-danger" id="createPasswordHelp"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="createTokenExpiry">Token expiry (minutes)</label>
                <input class="form-control" type="number" id="createTokenExpiry" min="1" max="1440" placeholder="Default 60" />
                <div class="form-text">Controls how long the link in the email remains valid.</div>
                <div class="form-text text-danger" id="createTokenExpiryHelp"></div>
              </div>
              <div class="col-md-6 d-flex align-items-center pt-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="createNoPassword" />
                  <label class="form-check-label" for="createNoPassword">Send setup email instead</label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="button" id="createUserSubmit" disabled>Create user</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="editUserModal" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">Edit user</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="editUserAlert"></div>
          <form id="editUserForm" novalidate>
            <input type="hidden" id="editUserId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="editFullName">Full name</label>
                <input class="form-control" type="text" id="editFullName" />
                <div class="form-text text-danger" id="editFullNameHelp"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="editPreferredName">Preferred name</label>
                <input class="form-control" type="text" id="editPreferredName" />
                <div class="form-text text-danger" id="editPreferredNameHelp"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="editEmail">Email</label>
                <input class="form-control" type="email" id="editEmail" />
                <div class="form-text text-danger" id="editEmailHelp"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="editRole">Role</label>
                <select class="form-select" id="editRole">
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
            </div>
          </form>
          <div class="small text-muted mt-3" id="editUserChangesSummary" aria-live="polite">No changes yet.</div>
          <p class="text-muted small mt-2 mb-0">Changes require confirmation. The user will be notified by email after you confirm.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="button" id="editUserSubmit" disabled>Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Simple Action Modal -->
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="confirmActionModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmActionTitle">Confirm action</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close" id="confirmActionCloseBtn"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="confirmActionAlert"></div>
          <div class="action-summary mb-3">
            <div class="action-summary-list">
              <div class="action-summary-row">
                <span class="label">User</span>
                <span class="summary-value" id="confirmActionSummaryUser">Unknown</span>
              </div>
              <div class="action-summary-row">
                <span class="label">Action</span>
                <span class="summary-value" id="confirmActionSummaryAction">—</span>
              </div>
              <div class="action-summary-row d-none" id="confirmActionSummaryExpiryRow">
                <span class="label">Token expiry</span>
                <span class="summary-value" id="confirmActionSummaryExpiry">Default</span>
              </div>
              <div>
                <span class="label d-block">Result</span>
                <span class="summary-value" id="confirmActionSummaryImpact">—</span>
              </div>
            </div>
            <div class="badge text-bg-warning-subtle border border-warning text-warning-emphasis d-none mt-2" id="confirmActionNotifyBadge">This action will notify the user by email.</div>
            <div class="text-danger small mt-1 d-none" id="confirmActionSummaryWarning">This action is destructive and cannot be undone.</div>
            <div class="mt-2 d-none" id="confirmActionSummaryMeta"></div>
          </div>
          <p class="mb-3 text-muted" id="confirmActionMessage">Review and confirm this action.</p>
          <div class="mb-3 d-none" id="confirmActionReasonWrap">
            <label class="form-label" for="confirmActionReason">Reason</label>
            <textarea class="form-control" id="confirmActionReason" rows="2"></textarea>
            <div class="form-text text-danger" id="confirmActionReasonHelp"></div>
          </div>
          <div class="mb-3 d-none" id="confirmActionEmailWrap">
            <label class="form-label" for="confirmActionEmail">User email</label>
            <input class="form-control" type="email" id="confirmActionEmail" />
            <div class="form-text text-danger" id="confirmActionEmailHelp"></div>
          </div>
          <div class="mb-3 d-none" id="confirmActionExpiryWrap">
            <label class="form-label" for="confirmActionExpirySelect">Token expiry</label>
            <div class="d-flex gap-2">
              <select class="form-select" id="confirmActionExpirySelect">
                <option value="">Use default</option>
                <option value="15">15 minutes</option>
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
                <option value="1440">24 hours</option>
                <option value="custom">Custom</option>
              </select>
              <input class="form-control d-none" type="number" id="confirmActionExpiryCustom" min="1" max="1440" step="1" placeholder="Minutes" style="width: 130px" />
            </div>
            <div class="form-text">Controls how long the link in the email remains valid.</div>
            <div class="form-text text-danger" id="confirmActionExpiryHelp"></div>
          </div>
          <div class="mb-0 d-none" id="confirmActionInputWrap">
            <label class="form-label" for="confirmActionInput">Type to confirm</label>
            <input class="form-control" type="text" id="confirmActionInput" />
            <div class="form-text text-danger" id="confirmActionInputHelp"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal" id="confirmActionCancelBtn">Cancel</button>
          <button class="btn btn-danger" type="button" id="confirmActionSubmit" disabled>Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="userDetailsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userDetailsTitle">User details</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning d-none" id="userDetailsAlert"></div>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <div class="card admin-card h-100">
                <div class="card-body">
                  <h6 class="text-uppercase text-muted">Profile</h6>
                  <div class="d-flex flex-column gap-2" id="userDetailsProfile"></div>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-6">
              <div class="card admin-card h-100">
                <div class="card-body">
                  <h6 class="text-uppercase text-muted">Usage</h6>
                  <div class="d-flex flex-column gap-2" id="userDetailsUsage"></div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="card admin-card">
                <div class="card-body">
                  <h6 class="text-uppercase text-muted">Actions</h6>
                  <div class="d-flex flex-wrap gap-2" id="userDetailsActions"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sessions Modal -->
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="sessionsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sessionsModalTitle">Sessions</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="sessionsAlert"></div>
          <div class="table-responsive">
            <table class="table table-sm align-middle table-striped">
              <thead class="table-header">
                <tr>
                  <th scope="col">Fingerprint</th>
                  <th scope="col">Issued</th>
                  <th scope="col">Expires</th>
                  <th scope="col">Device / IP</th>
                </tr>
              </thead>
              <tbody id="sessionsTbody">
                <tr><td colspan="4" class="text-center text-muted py-3">Loading sessions…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-outline-danger" type="button" id="sessionsForceLogoutBtn">Force logout all</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Language Modals -->
  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="languageModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="languageModalTitle">Language</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="languageModalAlert"></div>
          <form id="languageForm" novalidate>
            <input type="hidden" id="languageModalId" />
            <label class="form-label" for="languageModalName">Name</label>
            <input class="form-control" type="text" id="languageModalName" required />
            <div class="form-text text-danger" id="languageModalNameHelp"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="button" id="languageModalSubmit" disabled>Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="languageDeleteModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete language</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="languageDeleteAlert"></div>
          <p class="mb-3">This will remove the language from the list. Type DELETE to confirm.</p>
          <input class="form-control" type="text" id="languageDeleteInput" />
          <div class="form-text text-danger" id="languageDeleteHelp"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" type="button" id="languageDeleteSubmit" disabled>Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" role="dialog" tabindex="-1" data-bs-backdrop="static" id="logsDetailModal" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logsDetailTitle">Log details</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger d-none" id="logsDetailAlert"></div>
          <div class="row g-3" id="logsDetailContent"></div>
        </div>
        <div class="modal-footer flex-wrap gap-2">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-outline-primary" type="button" id="logsCopyRequestBtn">Copy request</button>
          <button class="btn btn-outline-primary" type="button" id="logsCopyResponseBtn">Copy response</button>
          <button class="btn btn-outline-secondary" type="button" id="logsCopyCorrelationBtn">Copy correlation id</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/http-interceptor.js"></script>
  <script src="assets/js/common.js"></script>
  <script src="assets/js/navbar.js"></script>
  <script src="assets/js/admin.js"></script>
</body>
</html>
