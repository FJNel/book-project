Book Project Contracts (UI/UX)
================================

Contracts Index & Implementation Order
--------------------------------------

A) Contracts Index
- Modal Contract
  - Location: contracts.txt -> "A) Modal Contract (Book Project standard)"
  - Reference implementations: web/assets/js/shared-add-modals.js, web/assets/js/book-details.js, web/assets/js/common.js (modalLock)
- Changes Contract
  - Location: contracts.txt -> "B) Changes Contract (applies to edit/change modals)"
  - Reference implementations: web/assets/js/book-details.js, web/assets/js/account.js, web/assets/js/storage-locations.js
- Icon Contract
  - Location: contracts.txt -> "C) Icon Contract (Bootstrap Icons font)"
  - Reference implementations: web/books.html, web/book-types.html, web/assets/js/book-details.js
- Interaction Contract
  - Location: contracts.txt -> "D) Interaction Contract (lists + tables)"
  - Reference implementations: web/books.html, web/assets/js/books.js, web/book-types.html, web/assets/js/book-types.js
- Dark Mode Styling Rules (added Phase 0)
  - Location: contracts.txt -> "E) Dark Mode Styling Rules"
  - Reference implementations: web/assets/css/styles.css, web/assets/js/common.js

B) Implementation Order Checklist
1. Modal Contract baseline
   - Why: modal structure and locking rules determine safe request handling and consistent error flows.
2. Changes Contract baseline
   - Why: change summaries depend on modal structure and must match modal validation/state rules.
3. Icon Contract
   - Why: icons are a visible UX contract; normalizing them avoids UI drift during later sweeps.
4. Interaction Contract
   - Why: interactions and hover rules build on the modal/icon baselines and must align with them.

C) Reference rule
- When a page differs intentionally from the reference implementation, the deviation must be documented in contracts.txt and applied consistently.

A) Modal Contract (Book Project standard)
----------------------------------------
Applies to any modal that accepts user input, performs a server action, or confirms a destructive change.

1) Live validation
- Each field has help text below it.
- Help text has two states:
  - Neutral guidance: class "form-text text-muted" (e.g., format hints).
  - Validation error: class "form-text text-danger" (e.g., "This field is required.").
- Validation runs on input/change and on submit.
- Field validity rules:
  - Required fields are valid only when trimmed value is non-empty and passes any format rules.
  - Optional fields are valid when empty OR valid per format rules.
  - Date fields use the partial date parser; invalid input is invalid.
- Field visual state:
  - When invalid: add "is-invalid" to the input/select/textarea; show error help text.
  - When valid and non-empty: add "is-valid" (optional if the UI already avoids green validation); clear error help.
  - When empty and optional: no validation classes, neutral guidance only.

2) Primary action enable/disable rules
- Primary action is disabled until:
  - all required fields are valid, AND
  - there is at least one meaningful change from the original values,
    OR (for confirm-only modals) the confirmation requirement is satisfied.
- Confirm-only modals (type-to-confirm):
  - Required phrase is shown in the modal (e.g., DELETE).
  - Input is trimmed and compared case-insensitively.
  - The primary button is enabled only when the phrase matches.

3) Request locking
- When a request is in flight:
  - inputs, selects, textareas, and all buttons are disabled (including close buttons),
  - modal cannot be closed (static backdrop + keyboard disabled),
  - the primary button shows a spinner.
- Use the shared modal lock helper (window.modalLock) where available.

4) Success + error outcomes
- On success:
  - modal closes by default,
  - UI updates in place (avoid full-page reload when feasible),
  - show inline success alerts when the flow stays on the same page.
- On error:
  - modal remains open,
  - show a standard alert:
    "<strong>API message</strong>: errors joined"
  - errors are rendered safely (no HTML injection; use renderApiErrorAlert or textContent).

5) Logging
Minimum console logs per modal:
- [Feature][Modal] opened
- [Feature][Modal] validation state changed (optional)
- [Feature][Modal] request started
- [Feature][Modal] request finished (success)
- [Feature][Modal] request failed with status/message

B) Changes Contract (applies to edit/change modals)
---------------------------------------------------
This is the standard "Changes" summary area for edit/change modals.

1) Placement + appearance
- Always placed at the bottom of the modal content, directly above the footer.
- Uses a stable container (no layout shift), e.g.,
  - <div class="small text-muted" id="...">No changes yet.</div>

2) Empty state
- When nothing differs from original values: "No changes yet."

3) Change phrasing rules (old → new)
- Each change is a full human-readable sentence.
- Consistent patterns:
  - "Changing title from 'Old' to 'New'."
  - "Changing preferred name from 'Johan' to 'Johan Nel'."
  - "Clearing subtitle (was 'Old')."
  - "Adding language: Afrikaans."
  - "Removing publisher (was 'Penguin')."
- Use single quotes around values. Use title case only where it belongs in the original value.

4) Date display rules
- Dates in the changes summary must use the normalized display format (not raw input).
- Use the same partial-date normalization rules used elsewhere in the app.
  - Example: user input "12/3/2023" → display "12 March 2023".

5) Null/empty behavior
- Field becomes empty: "Clearing <field> (was '<old>')."
- Field was empty and becomes filled: "Adding <field>: '<new>'."
- Field remains empty: no change entry.

6) Multi-item changes
- For tags/languages/authors lists:
  - Adds: "Adding tags: A, B, C." (list each item; if more than 6, show first 6 + "and N more").
  - Removes: "Removing tags: A, B." (same list rule).
  - Reorders (if applicable): "Reordering tags." (do not list every move).

These contracts are the single source of truth for modal behavior and edit/change summaries in the Book Project.

A1) Shared add modals (shared-add-modals.js)
--------------------------------------------
Purpose: keep shared add/edit modals consistent across pages and prevent one-off modal drift.

1) Canonical implementation
- Source of truth: `web/assets/js/shared-add-modals.js`.
- The shared modal host must be present in the page: `<div id="sharedAddRecordModals"></div>`.
- Modal markup is injected into the host; pages must not duplicate that markup.

2) Usage rules
- If a shared modal exists for a concept, all pages must use it via:
  `window.sharedAddModals.open('<type>', { mode: 'add'|'edit', initial: { ... } })`.
- Pages must not implement alternate add/edit modals for the same concept.
- Any shared modal behavior change is a contract-level change and must be tested across all consumers.

3) Covered concepts (current)
- Book Type, Author, Publisher, Series, Storage Location.

4) Reference consumers
- `web/book-details.html` + `web/assets/js/book-details.js` (baseline consumer).
- `web/book-types.html` + `web/assets/js/book-types.js` (Book Type add).
- `web/book-type-details.html` + `web/assets/js/book-type-details.js` (Book Type edit).

C) Icon Contract (Bootstrap Icons font)
--------------------------------------
Purpose: standardize icon usage across user + admin UI to prevent drift and keep interactions consistent.

1) Canonical markup + source of truth
- Use Bootstrap Icons font classes only: `<i class="bi bi-..."></i>`.
- Inline SVG icons are not allowed in Book Project UI.
- Do not mix icon sets. If a new icon is required, add it to this contract first.
- Icon-only buttons must keep an accessible label (aria-label or tooltip/title).
- Whitelisted exception: vendor assets under `api/docs/swagger-ui/` may contain inline SVG; do not modify vendor bundles.

2) Canonical mappings (Action/Concept → Icon class → Where used → Notes)
- Add → `bi bi-plus-square` → Add buttons across pages → Use for create/add actions.
- Edit → `bi bi-pencil-fill` → Edit buttons, manage icons → Use for edit/update actions.
- Delete → `bi bi-trash-fill` → Delete/permanent delete → Use only for destructive deletion.
- Remove → `bi bi-x-square` → Remove from list/relationship → Not for permanent deletion.
- Search → `bi bi-search` → Search inputs/toolbars → Inline in input group.
- Grid view → `bi bi-grid-3x3-gap` → View toggles → Card view icon.
- List view → `bi bi-list` → View toggles → Table/list view icon.
- Export/download → `bi bi-download` → Export actions → Icon-only allowed with tooltip.
- Raw data → `bi bi-filetype-json` → Raw data view → Use for JSON/raw data.
- Complete status → `bi bi-check-circle` → Status indicators → Use for complete/verified.
- Missing/incomplete → `bi bi-dash-circle` → Status indicators → Use for missing/incomplete.
- Revoke sessions → `bi bi-slash-circle` → Account sessions → Sign out all devices.
- Disable account → `bi bi-person-x-fill` → Account danger zone → Disable account.
- Enable account → `bi bi-person-check-fill` → Account admin enable → Enable account.
- API/DB Healthy → `bi bi-cloud-check` → Admin status → Healthy service state.
- API/DB Unhealthy → `bi bi-cloud-slash` → Admin status → Unhealthy service state.
- AI features → `bi bi-stars` → AI helper labels → Use only where AI assistance is described.
- Favourite (outline) → `bi bi-star` → Favourite toggle → Use when not selected.
- Favourite (filled) → `bi bi-star-fill` → Favourite toggle → Use when selected.
- Android → `bi bi-android` → Device indicators → Account sessions.
- Apple → `bi bi-apple` → Device indicators → Account sessions.
- Windows → `bi bi-windows` → Device indicators → Account sessions.
- Mac → `bi bi-command` → Device indicators → Account sessions.
- Linux → `bi bi-linux` → Device indicators → Account sessions.
- Phone → `bi bi-phone` → Device indicators → Account sessions.
- Desktop → `bi bi-pc-display-horizontal` → Device indicators → Account sessions.
- Unknown device → `bi bi-question-circle` → Device indicators + general unknown state → Also used for 404 page icon.
- Emails → `bi bi-envelope` → Admin email tools → Email tooling.
- Logs → `bi bi-clock-history` → Admin logs tools → Audit/logs.
- Usage → `bi bi-person-lines-fill` → Admin usage tools → Usage analytics.
- Books → `bi bi-book-half` → Dashboard + nav → Books feature card.
- Book Types → `bi bi-journals` → Dashboard + nav → Book Types feature card.
- Publishers → `bi bi-building-fill` → Dashboard + nav → Publishers feature card.
- Authors → `bi bi-people` → Dashboard + nav → Authors feature card.
- Series → `bi bi-collection-fill` → Dashboard + nav → Series feature card.
- Storage Locations → `bi bi-diagram-3-fill` → Dashboard + nav → Storage Locations feature card.
- Statistics → `bi bi-bar-chart-line-fill` → Dashboard + stats pages → Statistics feature card.
- Move → `bi bi-arrows-move` → Move actions → Storage locations move.
- Copy (outline) → `bi bi-clipboard` → Copy actions → Copy before success.
- Copy (done) → `bi bi-clipboard-check` → Copy actions → Show after success.
- Info tooltip → `bi bi-info-circle` → Form help tooltips → Inline next to labels.
- Restore → `bi bi-arrow-counterclockwise` → Restore from recycle bin → Soft-delete restore.
- View details → `bi bi-eye` → Row action “View” → Used in Book Types list.
- Pagination previous → `bi bi-arrow-left` → Pagination controls → Previous page.
- Pagination next → `bi bi-arrow-right` → Pagination controls → Next page.
- Navigation hint → `bi bi-chevron-right` → Clickable rows/chevrons → Book details hints.
- Expand all → `bi bi-arrows-expand` → Tree controls → Storage locations tree.
- Collapse all → `bi bi-arrows-collapse` → Tree controls → Storage locations tree.
- Tree expanded → `bi bi-chevron-down` → Tree rows → Storage locations expanded state.
- Clear → `bi bi-x` → Clear actions → Clear search/filter buttons.

3) Consistency rules
- Same action must use the same icon across user + admin surfaces.
- Use the same icon for the same concept in all pages.
- Do not change icon classes for a page without updating this contract and all related pages.

4) Behaviour notes
- Favourite icons: use `bi bi-star` for off, `bi bi-star-fill` for on.
- Copy icons: use `bi bi-clipboard` before copy, switch to `bi bi-clipboard-check` on success.

5) Adding new icons
- Confirm no existing icon fits the concept.
- Add the new icon to this contract with usage notes and affected pages.
- Update all relevant pages in the same change to prevent drift.

D) Interaction Contract (lists + tables)
----------------------------------------
Purpose: standardize list/table interactions across the app to ensure consistent hover, keyboard, and row-action behavior.

1) Scope + baseline
- Applies to list tables, card lists, and any "clickable row" list UI.
- Baseline implementation: Books page.
  - Reference: web/books.html, web/assets/js/books.js
- Additional reference pages (must match baseline unless documented):
  - web/book-types.html, web/assets/js/book-types.js
  - web/authors.html, web/assets/js/authors.js
  - web/publishers.html, web/assets/js/publishers.js
  - web/series.html, web/assets/js/series.js
  - web/storage-locations.html, web/assets/js/storage-locations.js
  - web/statistics.html, web/assets/js/statistics.js
  - web/admin-library.html, web/assets/js/admin-library.js
- web/author-details.html, web/assets/js/author-details.js
- web/publisher-details.html, web/assets/js/publisher-details.js
- web/series-details.html, web/assets/js/series-details.js
- web/book-details.html, web/assets/js/book-details.js
- Admin user directory row-click details modal:
  - Reference: web/admin.html (User Details Modal), web/assets/js/admin.js (Users table row click)
  - Rule: row click opens the user details modal with actions; actions inside the modal must follow Modal + Icon Contracts.

2) Clickable row markup
- Use the `clickable-row` class on any row/list item that is clickable.
- For navigation rows, add `data-row-href="..."` and set:
  - `tabindex="0"`
  - `role="link"`
- For non-navigation row actions (no URL), use `data-row-action="..."` and:
  - `tabindex="0"`
  - `role="button"`
- If row text is not descriptive, add `aria-label` that matches the primary action.

3) Pointer + hover rules
- Clickable rows: cursor must be pointer and hover background must be visible.
- Non-clickable rows: no pointer cursor and no hover styling that implies click.
- Hover and focus-visible backgrounds must not cause layout shift.

4) Event propagation rules
- Row click handlers must ignore interactions on controls:
  - Ignore clicks originating from `button`, `a`, `input`, `select`, `textarea`, or any element with `data-row-action` or `data-stop-row`.
- Row action buttons/links must call `event.stopPropagation()` to prevent row click.

5) Hover/focus-within parity for row actions
- Any action controls shown on hover must also appear on `:focus-within`.
- Use a stable container with `row-actions` class and keep layout fixed:
  - right-aligned
  - `white-space: nowrap`
  - fixed/min width so columns do not jitter

6) Keyboard interaction + accessibility
- Clickable rows must be tabbable and activate on Enter/Space.
- Action buttons must be tabbable and keep meaningful `aria-label` and/or tooltip text.
- Focus styling must remain visible and theme-aware.

7) Touch/no-hover rule + mobile exception
- On touch/no-hover devices, row actions must be accessible via focus-within.
- Project-specific exception: row edit/delete actions are intentionally hidden on mobile.
  - This is not a bug; it is a documented behavior for this project phase.

8) Loading/empty/error behavior
- Loading states must not leave rows clickable.
- Empty/error states must follow existing page patterns; do not add ad-hoc refresh buttons.
- Page loading modals/spinners must always close on success and error paths.

E) Dark Mode Styling Rules
--------------------------
1) Theme-aware styling only
- No hard-coded light colors (e.g., #fff, #f8f9fa, "text-dark" used to force light-mode contrast, inline styles with background-color/color) unless explicitly theme-aware.
- Prefer Bootstrap theme variables/classes and project theme tokens.

2) Hover + focus behavior
- Hover/focus backgrounds must not cause layout shift or reduce contrast in dark mode.
- Use shared utility classes or theme tokens; avoid per-page ad-hoc hover colors.

3) Phase 0 scan findings (for later remediation)
- web/admin-library.html:24 - hover background-color: #f8f9fa (light-only hover state)
- web/series-details.html:24 - hover background-color: #f8f9fa (light-only hover state)
- web/author-details.html:24 - hover background-color: #f8f9fa (light-only hover state)
- web/publisher-details.html:24 - hover background-color: #f8f9fa (light-only hover state)
- web/storage-locations.html:25 - hover background-color: #f8f9fa (light-only hover state)
- web/book-details.html:40,50 - background-color: #f8f9fa in local styles
- web/book-details.html:293 - inline style background-color: #f7f8f9 on card
- web/admin.html:33 - color: #fff (hard-coded light text)
- web/account.html:50 - color: #fff (hard-coded light text)
- web/statistics.html:43 - color: #fff (hard-coded light text)
- web/assets/css/styles.css:2 - --bp-surface: #ffffff (verify theme override is applied in dark mode)
- web/assets/js/books.js:783-865 - text-bg-light + text-dark badges (forced light backgrounds)
- web/assets/js/book-details.js:842-942 - bg-light/text-dark/button class usage (forced light backgrounds)
- web/assets/js/storage-locations.js:407-580 - text-bg-light + text-dark badges (forced light backgrounds)
- web/assets/js/add-book-review.js:46 - bg-light text-dark badges (forced light backgrounds)

F) Modal Copy Library (Drafts)
------------------------------
1) No write permissions (draft)
- Title: "Read-only access"
- Body: "You are viewing this library in read-only mode. Edits are disabled."
- Primary button: "Close"
- Secondary button: (omit unless a help pattern already exists)
- Behavior notes:
  - Show when a disabled action is clicked in admin read-only context.
  - Button closes the modal; no side effects.

G) Terminology Audit: "entity/entities"
---------------------------------------
Table columns: Location | Context | User-facing? | Proposed replacement | Notes/risk

| Location | Context | User-facing? | Proposed replacement | Notes/risk |
| --- | --- | --- | --- | --- |
| api/docs/swagger-ui/LICENSE:17 | Internal vendor license | No | "third parties" | Third-party license text; not rendered to users but keep vendor files untouched. |
| api/routes/import-export.js:525 | Internal code comment | No | "records"/"items" | Comment only; no UI impact. |
| api/routes/search.js:76 | Internal code comment | No | "records"/"items" | Comment only; no UI impact. |

OpenAPI/SwaggerUI audit notes:
- api/docs/openapi.yaml: no occurrences found in summary/description/examples/tags.
- SwaggerUI assets: LICENSE contains the term but does not render into the UI.
